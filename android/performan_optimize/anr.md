# ANR

## 发生条件

主线程由于耗时操作而不能正确响应用户输入事件。

> 确保高效的计算始终至关重要，但即使最高效的代码仍然需要时间来运行。

在 Android 中，应用响应性由 Activity 管理器和窗口管理器系统服务监控。当 Android 检测到以下某一项条件时，便会针对特定应用显示 ANR 对话框：

* 在 5 秒内对输入事件（例如按键或屏幕轻触事件）没有响应。
* BroadcastReceiver 在 10 秒后尚未执行完毕。

## 避免 ANR

在主线程中运行的所有方法都应该尽可能减少在此线程中的操作。**特别是在 onCreate\(\) 和 onResume\(\) 等关键生命周期方法中，Activity 应尽量减少进行设置所需的操作。**

可能会长时间运行的操作（例如网络或数据库操作）或计算成本高昂的计算（例如调整位图大小）应在**工作线程**中完成（如果是数据库操作，则应通过异步请求完成）。

创建自己的 `Thread` 或 `HandlerThread` 类时应该调用 Process.setThreadPriority\(\) 并传递 `THREAD_PRIORITY_BACKGROUND`从而**将线程优先级设为“后台”优先**。如果不通过这种方式将线程设为较低的优先级，则此线程仍可能会让应用变慢，因为默认情况下，此线程会按照与界面线程相同的优先级操作。

对 BroadcastReceiver 执行时间的特定约束强调了广播接收器的功能：在后台执行少量离散工作，例如保存设置或注册 Notification。因此，与在界面线程中调用的其他方法一样，应用应避免在广播接收器中执行可能会长时间运行的操作或计算。但如果需要执行可能需要长时间运行的操作以响应 intent 广播，则应用应启动 `IntentService`，而不是通过工作线程执行密集型操作。

## ANR 检测



## 参考

[使应用能迅速响应](https://developer.android.com/training/articles/perf-anr?hl=zh-CN)

